<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Productos</title>
  <style>
    /* Estilo coherente con tu tema blanco/negro/gris */
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
      color: #222;
    }
    header {
      text-align: center;
      margin-bottom: 18px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    .top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
      margin-bottom: 12px;
    }
    .card {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-bottom: 18px;
    }
    form input, form textarea {
      width:100%;
      padding:8px;
      margin:6px 0;
      border:1px solid #ddd;
      border-radius:6px;
      box-sizing:border-box;
      background:#fafafa;
    }
    button {
      background:#333;
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
    }
    button.secondary {
      background:#555;
    }
    table {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:8px;
      overflow:hidden;
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    th, td {
      padding:10px 12px;
      border-bottom:1px solid #eee;
      text-align:left;
    }
    th { background:#f3f3f3; color:#333; }
    tr:hover td { background:#fafafa; }
    .actions { display:flex; gap:8px; }
    .btn-edit { background:#2e7d32; }
    .btn-delete { background:#d33; }
    .muted { color:#666; font-size:0.95rem; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h2>Productos</h2>
      <div class="muted">Ver productos - solo administradores pueden gestionar (crear/editar/eliminar)</div>
    </header>

    <div class="top">
      <div>
        <button onclick="window.location.href='/'">← Volver al inicio</button>
      </div>
      <div id="user-info" class="muted"></div>
    </div>

    <!-- Formulario de creación (se oculta si no es admin) -->
    <div id="admin-form" class="card" style="display:none;">
      <h3 id="form-title">Crear producto</h3>
      <form id="productForm">
        <input id="name" placeholder="Nombre del producto" required />
        <textarea id="description" placeholder="Descripción (opcional)"></textarea>
        <input id="price" placeholder="Precio (€)" type="number" step="0.01" min="0" required />
        <div style="margin-top:8px;">
          <button type="submit" id="submitBtn">Agregar producto</button>
          <button type="button" class="secondary" onclick="cancelEdit()">Cancelar</button>
        </div>
      </form>
    </div>

    <!-- Lista de productos (visible para todos los usuarios autenticados) -->
    <div class="card">
      <table aria-label="Lista de productos">
        <thead>
          <tr><th>Nombre</th><th>Descripción</th><th>Precio (€)</th><th id="acciones-col">Acciones</th></tr>
        </thead>
        <tbody id="productTableBody">
          <!-- Productos cargados dinámicamente -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Usa sessionStorage (como en el resto de tu app) — permite sesiones independientes por ventana
    const token = sessionStorage.getItem('token') || localStorage.getItem('token');
    if (!token) {
      alert('Debes iniciar sesión primero.');
      window.location.href = '/';
    }

    // Decodificar token con precaución
    let payload = {};
    try {
      payload = JSON.parse(atob(token.split('.')[1]));
    } catch (e) {
      console.error('Token inválido', e);
      alert('Token inválido — inicia sesión de nuevo.');
      sessionStorage.removeItem('token'); localStorage.removeItem('token');
      window.location.href = '/';
    }

    const isAdmin = payload.role === 'admin';
    document.getElementById('user-info').textContent = `Conectado: ${payload.username} (${payload.role})`;

    // Mostrar/ocultar el formulario de administración
    const adminForm = document.getElementById('admin-form');
    const accionesCol = document.getElementById('acciones-col');
    if (isAdmin) {
      adminForm.style.display = 'block';
      accionesCol.style.display = 'table-cell';
    } else {
      adminForm.style.display = 'none';
      // Si no admin, ocultar la columna de acciones
      accionesCol.style.display = 'none';
    }

    const tableBody = document.getElementById('productTableBody');
    let editId = null;

    async function loadProducts() {
      try {
        const res = await fetch('/api/products', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) {
          if (res.status === 401 || res.status === 403) {
            alert('No autorizado. Inicia sesión de nuevo.');
            sessionStorage.removeItem('token'); localStorage.removeItem('token');
            window.location.href = '/';
            return;
          }
          throw new Error('Error cargando productos');
        }
        const products = await res.json();
        renderTable(products);
      } catch (err) {
        console.error(err);
        alert('Error al cargar productos.');
      }
    }

    function renderTable(products) {
      tableBody.innerHTML = '';
      products.forEach(p => {
        const tr = document.createElement('tr');

        const nameTd = document.createElement('td');
        nameTd.textContent = p.name;

        const descTd = document.createElement('td');
        descTd.textContent = p.description || '';

        const priceTd = document.createElement('td');
        priceTd.textContent = Number(p.price).toFixed(2);

        tr.appendChild(nameTd);
        tr.appendChild(descTd);
        tr.appendChild(priceTd);

        // Acciones (solo si es admin)
        const actionsTd = document.createElement('td');
        if (isAdmin) {
          const editBtn = document.createElement('button');
          editBtn.className = 'btn-edit';
          editBtn.textContent = 'Editar';
          editBtn.onclick = () => startEdit(p._id, p.name, p.description || '', p.price);

          const delBtn = document.createElement('button');
          delBtn.className = 'btn-delete';
          delBtn.textContent = 'Eliminar';
          delBtn.onclick = () => deleteProduct(p._id);

          const wrapper = document.createElement('div');
          wrapper.className = 'actions';
          wrapper.appendChild(editBtn);
          wrapper.appendChild(delBtn);
          actionsTd.appendChild(wrapper);
        } else {
          // si no admin dejar celda vacía (y ocultada con CSS si quieres)
          actionsTd.textContent = '';
        }
        tr.appendChild(actionsTd);

        tableBody.appendChild(tr);
      });
    }

    // ---------- ADMIN: crear / editar / eliminar ----------
    const form = document.getElementById('productForm');
    const inputName = document.getElementById('name');
    const inputDesc = document.getElementById('description');
    const inputPrice = document.getElementById('price');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAdmin) return alert('Acceso denegado');

      const name = inputName.value.trim();
      const description = inputDesc.value.trim();
      const price = parseFloat(inputPrice.value);

      if (!name || isNaN(price)) return alert('Completa nombre y precio válido');

      const payload = { name, description, price };

      try {
        const url = editId ? `/api/products/${editId}` : '/api/products';
        const method = editId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.json().catch(()=>({message:'Error'}));
          return alert(err.message || 'Error en la operación');
        }

        // limpio formulario
        editId = null;
        inputName.value = '';
        inputDesc.value = '';
        inputPrice.value = '';
        submitBtn.textContent = 'Agregar producto';
        loadProducts();
      } catch (err) {
        console.error(err);
        alert('Error de red al guardar producto');
      }
    });

    function startEdit(id, name, description, price) {
      if (!isAdmin) return alert('Acceso denegado');
      editId = id;
      inputName.value = name;
      inputDesc.value = description;
      inputPrice.value = price;
      submitBtn.textContent = 'Guardar cambios';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
      editId = null;
      inputName.value = '';
      inputDesc.value = '';
      inputPrice.value = '';
      submitBtn.textContent = 'Agregar producto';
    }

    async function deleteProduct(id) {
      if (!confirm('¿Seguro?')) return;
      try {
        const res = await fetch(`/api/products/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({message:'Error'}));
          return alert(err.message || 'Error al eliminar');
        }
        loadProducts();
      } catch (err) {
        console.error(err);
        alert('Error de red al eliminar');
      }
    }

    // carga inicial
    loadProducts();
  </script>
</body>
</html>
