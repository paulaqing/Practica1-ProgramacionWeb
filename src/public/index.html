<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Inicio - Portal de Productos y Chat</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h2, h3 { color: #111; }
        input, select, button {
            padding: 0.5rem;
            margin: 0.3rem 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            background-color: #333;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #555;
        }
        #chat-section, #inicio-section {
            display: none;
        }
        #auth-section, #inicio-section, #chat-section {
            max-width: 400px;
            margin: auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            padding: 0.3rem 0;
            border-bottom: 1px solid #eee;
        }
        #form {
            display: flex;
            margin-top: 1rem;
        }
        #input {
            flex: 1;
            padding: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="auth-section">
        <h2>Autenticación</h2>
        <input id="username" placeholder="Usuario" required>
        <input id="password" type="password" placeholder="Contraseña" required>
        <select id="role">
            <option value="user">Usuario</option>
            <option value="admin">Administrador</option>
        </select>
        <br>
        <button onclick="register()">Registrar</button>
        <button onclick="login()">Iniciar Sesión</button>
    </div>

    <div id="inicio-section">
        <h2>Inicio</h2>
        <p>Bienvenido, <span id="user-name"></span> (<span id="user-role"></span>)</p>
        <button onclick="goToChat()">Ir al Chat</button>
        <button onclick="goToProducts()">Ir a Productos</button>
        <button onclick="logout()">Cerrar sesión</button>
    </div>

    <div id="chat-section">
        <h3>Chat</h3>
        <ul id="messages"></ul>
        <form id="form">
            <input id="input" autocomplete="off" placeholder="Escribe un mensaje" />
            <button>Enviar</button>
        </form>
        <button onclick="backToInicio()">Volver al inicio</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        const token = sessionStorage.getItem('token');
        const authSection = document.getElementById('auth-section');
        const inicioSection = document.getElementById('inicio-section');
        const chatSection = document.getElementById('chat-section');
        const userNameSpan = document.getElementById('user-name');
        const userRoleSpan = document.getElementById('user-role');

        function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;

            fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role })
            })
            .then(r => r.json())
            .then(data => alert(data.message));
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            }).then(r => r.json()).then(data => {
                if (data.token) {
                    sessionStorage.setItem('token', data.token);
                    showInicio(data.token);
                } else {
                    alert('Usuario o contraseña incorrectos');
                }
            });
        }

        function decodeToken(token) {
            return JSON.parse(atob(token.split('.')[1]));
        }

        function showInicio(token) {
            authSection.style.display = 'none';
            inicioSection.style.display = 'block';
            const payload = decodeToken(token);
            userNameSpan.textContent = payload.username;
            userRoleSpan.textContent = payload.role;
        }

        function goToChat() {
            inicioSection.style.display = 'none';
            chatSection.style.display = 'block';
            connectToChat();
        }

        function goToProducts() {
            window.location.href = '/products.html';
        }

        function backToInicio() {
            chatSection.style.display = 'none';
            inicioSection.style.display = 'block';
            if (socket) socket.disconnect();
        }

        function logout() {
            sessionStorage.removeItem('token');
            if (socket) socket.disconnect();
            authSection.style.display = 'block';
            inicioSection.style.display = 'none';
            chatSection.style.display = 'none';
        }

        function connectToChat() {
            socket = io({ auth: { token: sessionStorage.getItem('token') } });
            const messages = document.getElementById('messages');
            const form = document.getElementById('form');
            const input = document.getElementById('input');

            socket.on('messageHistory', history => {
                messages.innerHTML = '';
                history.forEach(msg => {
                    const li = document.createElement('li');
                    li.textContent = `${msg.name} (${msg.timestamp}): ${msg.msg}`;
                    messages.appendChild(li);
                });
            });

            socket.on('chatmessage', msg => {
                const li = document.createElement('li');
                li.textContent = `${msg.name} (${msg.timestamp}): ${msg.msg}`;
                messages.appendChild(li);
                window.scrollTo(0, document.body.scrollHeight);
            });

            form.addEventListener('submit', e => {
                e.preventDefault();
                if (input.value.trim()) {
                    socket.emit('chatmessage', input.value.trim());
                    input.value = '';
                }
            });
        }

        if (token) showInicio(token);
    </script>
</body>
</html>
